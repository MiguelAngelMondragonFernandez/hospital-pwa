<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enfermer√≠a - Esc√°ner QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        #qr-reader__dashboard_section_swaplink {
            display: none !important;
        }
    </style>
</head>
<link rel="manifest" href="manifest.json">
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
</script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <header class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-2xl font-bold text-gray-800">üë®‚Äç‚öïÔ∏è Enfermer√≠a</h1>
                <button id="btn-logout" class="text-red-500 hover:text-red-700 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
            <p class="text-gray-500 text-sm">Escanea el c√≥digo QR de la cama</p>

        </header>

        <!-- Scanner Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="text-center mb-4">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 mb-2">Escanear C√≥digo QR</h2>
                <p class="text-gray-500 text-sm">Apunta la c√°mara al c√≥digo QR de la cama</p>
            </div>

            <!-- QR Reader Container -->
            <div id="qr-reader-container" class="hidden">
                <div id="qr-reader" class="rounded-lg overflow-hidden border-4 border-blue-200"></div>
                <button id="btn-stop-scan"
                    class="mt-2 w-full text-red-500 hover:text-red-700 font-medium text-sm py-2 border border-red-200 rounded-lg">
                    Cerrar C√°mara
                </button>
            </div>

            <!-- Start Scan Button Container -->
            <div id="start-scan-container" class="text-center py-4">
                <button id="btn-start-scan"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center gap-2 mx-auto">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Activar C√°mara
                </button>
            </div>

            <!-- Scanner Status -->
            <!-- Scanner Status -->
            <div id="scanner-status" class="mt-4 text-center text-sm text-gray-600"></div>
        </div>

        <!-- Quick Access Button -->
        <button id="btn-my-beds"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Ver Mis Camas Asignadas
        </button>

        <!-- Loader -->
        <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 flex flex-col items-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
                <p class="text-gray-700 font-semibold">Cargando informaci√≥n...</p>
            </div>
        </div>
    </div>

    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/nurse.js"></script>

    <script>
        const API_URL = 'http://localhost:8082/api';
        let html5QrCode;

        // Logout
        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = './index.html';
        });

        // Navigate to my beds
        document.getElementById('btn-my-beds').addEventListener('click', () => {
            window.location.href = './nurse/beds.html';
        });

        // Show/Hide loader
        function showLoader(show) {
            document.getElementById('loader').classList.toggle('hidden', !show);
        }

        // Initialize QR Scanner
        function startScanner() {
            document.getElementById('start-scan-container').classList.add('hidden');
            document.getElementById('qr-reader-container').classList.remove('hidden');

            html5QrCode = new Html5Qrcode("qr-reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).catch(err => {
                document.getElementById('scanner-status').innerHTML =
                    '<span class="text-red-500">‚ùå Error al iniciar la c√°mara</span>';
                console.error("Error starting scanner:", err);
                stopScanner();
            });

            document.getElementById('scanner-status').innerHTML =
                '<span class="text-blue-600">üì∑ C√°mara lista - Escanea un c√≥digo QR</span>';
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('qr-reader-container').classList.add('hidden');
                    document.getElementById('start-scan-container').classList.remove('hidden');
                    document.getElementById('scanner-status').innerHTML = '';
                    html5QrCode.clear();
                }).catch(err => console.error(err));
            } else {
                document.getElementById('qr-reader-container').classList.add('hidden');
                document.getElementById('start-scan-container').classList.remove('hidden');
            }
        }

        async function onScanSuccess(decodedText) {
            // Stop scanner
            stopScanner();
            showLoader(true);

            const bedId = decodedText;
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const cachedAssignments = localStorage.getItem(`cached_assignments_${user.id}`);

            // 1. Try Cache First ("OnlyCache" strategy preference)
            if (cachedAssignments) {
                try {
                    const parsed = JSON.parse(cachedAssignments);
                    const assignments = parsed.data || [];

                    // Find assignment for this bed
                    const assignment = assignments.find(a => a.bed && a.bed.id == bedId);

                    if (assignment) {
                        console.log('Using cached bed info (OnlyCache strategy)');
                        const bed = assignment.bed;
                        const patient = bed.paciente;

                        const offlineData = {
                            data: {
                                patientName: patient ? `${patient.nombre} ${patient.apellidos}` : 'Sin paciente',
                                bloodType: patient ? patient.tipoSangre : '--',
                                bedId: bed.id,
                                ailments: patient ? patient.padecimientos : '',
                                description: patient ? patient.descripcion : '',
                                bedStatus: bed.status,
                                estado: 'verde', // Default
                                solicitudId: null
                            }
                        };

                        // Status color mapping
                        if (bed.status === 'urgente') offlineData.data.estado = 'rojo';
                        else if (bed.status === 'precaucion') offlineData.data.estado = 'amarillo';

                        localStorage.setItem('currentBed', JSON.stringify(offlineData));
                        window.location.href = './nurse/patients.html';
                        return;
                    }
                } catch (e) {
                    console.warn('Error parsing cache:', e);
                }
            }

            // 2. Fallback to Network if not in cache
            try {
                const response = await fetch(`${API_URL}/bed/${bedId}/paciente`);

                if (response.ok) {
                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.message || 'Error en respuesta');
                    }

                    localStorage.setItem('currentBed', JSON.stringify(data));
                    window.location.href = './nurse/patients.html';
                } else {
                    throw new Error('Error al consultar servidor');
                }
            } catch (error) {
                console.error('Scan error:', error);
                showLoader(false);
                alert('‚ùå No se encontr√≥ informaci√≥n (Ni en cach√©, ni en servidor)');
                // Don't auto restart scanner
            }
        }

        function onScanError(errorMessage) {
            // Ignore scan errors
        }

        // Button Listeners
        document.getElementById('btn-start-scan').addEventListener('click', startScanner);
        document.getElementById('btn-stop-scan').addEventListener('click', stopScanner);

        // Stop scanner on page unload
        window.addEventListener('beforeunload', () => {
            if (html5QrCode) {
                html5QrCode.stop();
            }
        });
    </script>
</body>

</html>